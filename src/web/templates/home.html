{% extends "layout.html" %}
{% block styles %}
  {{ super() }}
  <link href="{{ url_for('static', filename='css/home.css') }}" rel="stylesheet">
{% endblock %}

<!-- Sidebar -->
{% block side_bar %}
  <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="sidebar">

    <!-- Sidebar - Brand -->
    <a class="sidebar-brand d-flex align-items-center justify-content-center" href="{{ url_for('home') }}">
      <div class="sidebar-brand-icon rotate-n-15">
        <i class="fas fa-laugh-wink"></i>
      </div>
      <div class="sidebar-brand-text mx-3">Sins On Twitter</div>
    </a>

    <!-- Divider -->
    <hr class="sidebar-divider my-0">

    <!-- Nav Item - Dashboard -->
    <li class="nav-item active">
      <a class="nav-link">
        <i class="fas fa-fw fa-search"></i>
        <span>Keywords</span>
      </a>
      <div>
        <input type="text" id="keywords" value="" data-role="tagsinput"/>
      </div>
    </li>

    <!-- Divider -->
    <hr class="sidebar-divider">

    <!-- sin selector -->
    <li class="nav-item active">
      <a class="nav-link">
        <i class="fas fa-fw fa-address-card"></i>
        <span>Sin Type</span>
      </a>
      <select class="custom-select" id="sin-select" name="crime-select" onchange="onSinSelectChange()">
        {% for option in option_list %}
          <option value="{{ option.sin }}" class="dropdown-item">{{ option.sin }}</option>
        {% endfor %}
      </select>
    </li>

    <!-- state selector -->
    <li class="nav-item active">
      <a class="nav-link">
        <i class="fas fa-fw fa-globe-asia"></i>
        <span>State in Australia</span>
      </a>
      <select class="custom-select" id="state-select" name="state-select">
        {% for state in option_list[0].states %}
          <option value="{{ state }}" class="dropdown-item">{{ state }}</option>
        {% endfor %}
      </select>
    </li>

    <!-- database selector -->
    <li class="nav-item active">
      <a class="nav-link">
        <i class="fas fa-fw fa-database"></i>
        <span>Data in Australia</span>
      </a>
      <div class="checkbox-group" id="database-checkboxs">
        {% for database in option_list[0].databases %}
          <div class="form-check">
            <input type="checkbox" class="form-check-input" id="checkbox-{{ database }}" checked>
            <label class="form-check-label" for="checkbox-{{ database }}">{{ database }}</label>
          </div>
        {% endfor %}
      </div>
    </li>

    <hr class="sidebar-divider">

    <!-- chart select -->
    <li class="nav-item active">
      <a class="nav-link">
        <i class="fas fa-fw fa-chart-area"></i>
        <span>Chart Type</span>
      </a>
      <div class="radio-group" id="chart-radio">
        <div>
          <input type="radio" id="bar" name="chart" value="bar" checked>
          <label for="bar">Bar Chart</label>
        </div>
        <div>
          <input type="radio" id="radar" name="chart" value="radar">
          <label for="radar">Radar Chart</label>
        </div>
      </div>
    </li>

    <button class="btn btn-light" id="searchBtn" onclick="search()">
      Search
    </button>
  </ul>
{% endblock %}

<!-- Display Area -->
{% block content %}
  <div name="visualize" style="width: 80%; position: relative; left: 20px;top: 20px;">
    <div id="chartArea" style="height: 500px">
      <div id="title">
        <tab>Twitter data Vs Aurin data</tab>
      </div>
      <div id="content" style="position: relative;width: 80%;height: 80%;left:30px ">
        <canvas id="barChart"></canvas>
      </div>
    </div>

    <div id="map" style="height: 50%">
      <div class="title">
        <tab style="display: block"> Map</tab>
      </div>
    </div>

  </div>
{% endblock %}

{% block javascript %}
  {{ super() }}
  {# ----------------------- Map visualization part -----------------------------------------#}
  <script type='text/javascript' src='http://www.google.com/jsapi'></script>
  <script type='text/javascript'>google.load('visualization', '1', {'packages': ['geochart']});
  google.setOnLoadCallback(drawVisualization);

  function drawVisualization() {
      var data = new google.visualization.DataTable();


      data.addColumn('string', 'Country');
      data.addColumn('number', 'Value');


      data.addRows([
          ['New South Wales',0.3],
          ['Queensland', 0.4],
          ['South Australia', 0.7],
          ['Tasmania', 0.2],
          ['Victoria', 0.4],
          ['Western Australia', 0.5],
          ['Northern Territory', 0.6]]);



      var options = {
          backgroundColor: {fill: '#FFFFFF', stroke: '#FFFFFF', strokeWidth: 0},
          colorAxis: {
              minValue: 0,
              maxValue: 1,
              colors: ['#e6ffe6', '#003300']
          },
          legend: 'Map of Sin On Twitter',
          backgroundColor: {fill: '#FFFFFF', stroke: '#FFFFFF', strokeWidth: 0},
          displayMode: 'region',
          enableRegionInteractivity: 'true',
          resolution: 'provinces',
          sizeAxis: {minValue: 1, maxValue: 1, minSize: 10, maxSize: 10},
          region: 'AU',
          keepAspectRatio: true,
          width: 2000,
          height: 900,
      };
      var chart = new google.visualization.GeoChart(document.getElementById('map'));

      chart.draw(data, options);
  }
  </script>



  {#------------ Chart visualzation part---------------------------------------------- #}
  <script>
      new Chart(document.getElementById("barChart"), {
          type: 'bar',
          data: {
              // areas location
              labels: ['New South Wales', 'Queensland', 'South Australia', 'Tasmania', 'Victoria', 'Western Australia', 'Northern Territory'],


              datasets: [{
                  label: "Percentage of Swearing Tweets",
                  backgroundColor: "#3e95cd",
                  data: [12, 32, 54, 23, 43, 12, 9],
                  boarderWidth: 1
              },
                  {
                      label: "Violent Crime Rate",
                      backgroundColor: "#8e5ea2",
                      data: [23, 43, 11, 32, 13, 34, 21],
                      boarderWidth: 1
                  }
              ]
          },
          options: {

              mode: 'index',
              label: true,
              maintainAspectRatio: false,
              responsive: true,
              legend: {display: true},
              title: {
                  display: true,
              }

          }
      });

      /**
       * sin selector changed, dynamically change the state and database options
       */
      function onSinSelectChange() {
          let options = {{ option_list|tojson }};
          let selectedSin = $("#sin-select").val();
          let stateSelector = $("#state-select");
          let databaseCheckboxs = $("#database-checkboxs");

          stateSelector.empty();
          databaseCheckboxs.empty();
          for (let i in options) {
              let item = options[i];
              if (item.sin === selectedSin) {
                  for (let j in item.states) {
                      let state = item.states[j];
                      stateSelector.append($('<option/>', {'value': state, 'text': state}));
                  }

                  for (let j in item.databases) {
                      let database = item.databases[j];

                      // use database name as element id
                      let checkbox = "<div class='form-check'>" +
                          "<input type='checkbox' class='form-check-input' id='" + database + "' checked></input>" +
                          "<label class='form-check-label' for='" + database + "'>" + database + "</label>" +
                          "</div>";
                      databaseCheckboxs.append(checkbox);
                  }
              }
          }
      }

      /**
       * click search button,
       * submit form data by ajax
       */
      function search() {
          let databaseGroup = $('#database-checkboxs');
          let chartRadioGroup = $('#chart-radio');

          let data = {
              keywords: $("#keywords").tagsinput("items"),
              sin: $("#sin-select").val(),
              state: $("#state-select").val(),
              databases: getSelectedCheckboxs(databaseGroup),
              chart: getRadioValByName(chartRadioGroup, 'chart'),
          };

          console.log(data);

          let options = {
              url: "{{ url_for('search') }}",
              dataType: "json",
              contentType: "application/json",
              type: "post",
              data: JSON.stringify(data),
          };

          let callback = function (responseText, statusText) {
              console.log("success");
          };

          $.ajax(options).done(callback);
      }

      /**
       * get value of the radio in the form
       * @param element radio group
       * @param name name of the radio
       * @returns value of the radio
       */
      function getRadioValByName(element, name) {
          let val;
          let radios = $('[name=' + name + ']');

          for (let i = 0, len = radios.length; i < len; i++) {
              if (radios[i].checked) {
                  val = radios[i].value;
                  break;
              }
          }
          return val;
      }

      /**
       * get the list of selected databases
       * @param element checkbox group
       * @returns {Array} list of database name
       */
      function getSelectedCheckboxs(element) {
          let checkboxs = $('[type=checkbox]');
          let selectedList = [];

          for (let i = 0, len = checkboxs.length; i < len; i++) {
              if (checkboxs[i].checked) {
                  selectedList.push($(checkboxs[i]).attr('id'));
              }
          }
          return selectedList;
      }
  </script>
{% endblock %}